#!/bin/bash
# Network UPS Tools - upssched-cmd
# Script ejecutado por upssched para manejar eventos

# Usuario que recibir√° las notificaciones de escritorio
# Cambiar si es necesario
NOTIFY_USER="${SUDO_USER:-walker}"
DISPLAY=":0"
DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$(id -u $NOTIFY_USER)/bus"

# Funci√≥n para enviar notificaci√≥n de escritorio
send_notification() {
    local urgency="$1"
    local summary="$2"
    local body="$3"
    local icon="${4:-dialog-information}"
    
    # Enviar a trav√©s del usuario correcto
    sudo -u "$NOTIFY_USER" \
        DISPLAY="$DISPLAY" \
        DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS" \
        notify-send \
        --urgency="$urgency" \
        --icon="$icon" \
        --app-name="UPS Monitor" \
        "$summary" \
        "$body"
}

# Log de eventos
log_event() {
    logger -t upssched-cmd "$1"
}

case "$1" in
    onbatt)
        MESSAGE="El UPS est√° funcionando con bater√≠a. Verifica el suministro el√©ctrico."
        log_event "ONBATT: $MESSAGE"
        send_notification "critical" "‚ö†Ô∏è UPS en Bater√≠a" "$MESSAGE" "battery-caution"
        ;;
    
    online)
        MESSAGE="El suministro el√©ctrico se ha restaurado. El UPS est√° cargando."
        log_event "ONLINE: $MESSAGE"
        send_notification "normal" "‚úì Electricidad Restaurada" "$MESSAGE" "battery-full-charging"
        ;;
    
    lowbatt)
        MESSAGE="¬°BATER√çA BAJA! El sistema se apagar√° pronto para proteger tus datos."
        log_event "LOWBATT: $MESSAGE"
        send_notification "critical" "üî¥ BATER√çA BAJA" "$MESSAGE" "battery-empty"
        # Reproducir sonido de alerta si est√° disponible
        paplay /usr/share/sounds/freedesktop/stereo/alarm-clock-elapsed.oga 2>/dev/null || true
        ;;
    
    commbad)
        MESSAGE="Se perdi√≥ la comunicaci√≥n con el UPS. Verifica la conexi√≥n."
        log_event "COMMBAD: $MESSAGE"
        send_notification "critical" "‚ö†Ô∏è UPS Desconectado" "$MESSAGE" "network-error"
        ;;
    
    commok)
        MESSAGE="Comunicaci√≥n con el UPS restaurada."
        log_event "COMMOK: $MESSAGE"
        send_notification "normal" "‚úì UPS Conectado" "$MESSAGE" "network-idle"
        ;;
    
    shutdown)
        MESSAGE="El sistema se est√° apagando debido al estado del UPS."
        log_event "SHUTDOWN: $MESSAGE"
        send_notification "critical" "üî¥ Apagando Sistema" "$MESSAGE" "system-shutdown"
        ;;
    
    replbatt)
        MESSAGE="La bater√≠a del UPS necesita ser reemplazada."
        log_event "REPLBATT: $MESSAGE"
        send_notification "normal" "‚ö†Ô∏è Reemplazar Bater√≠a" "$MESSAGE" "battery-missing"
        ;;
    
    shutdown-timer)
        MESSAGE="Han pasado 20 minutos en bater√≠a. Iniciando apagado para proteger datos."
        log_event "SHUTDOWN-TIMER: $MESSAGE - Iniciando shutdown por timeout de bater√≠a"
        send_notification "critical" "üî¥ Apagado Autom√°tico" "$MESSAGE" "system-shutdown"
        # Esperar 10 segundos para que se vea la notificaci√≥n
        sleep 10
        # Apagar el sistema
        /usr/bin/systemctl poweroff
        ;;
    
    *)
        log_event "Evento desconocido: $1"
        ;;
esac

exit 0
